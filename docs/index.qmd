---
title: "Abschlussprojekt"
subtitle: "rstatsZH-K009: "
author: "DaaniiH"
format: 
  html:
    embed-resources: true
    toc: true
editor: visual
chunk_output_type: console
---

# Packages laden

```{r}

library(readr)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(forcats)
library(ggthemes)
library(scales)
library(lubridate)
library(knitr)     # Package wird für Funktion kable() geladen
library(DT)        # Package wird für Funktion datatable() geladen
library(gt)        # Package wird für Funktion gt() geladen

```

# Daten laden

```{r}

data_staatenkleingruppe <-  read_csv(here::here("data/raw/Quartiere_Jahr_KTZH_00002604_00005328.csv"))
# <<<<<<< HEAD
# View(data_staatenkleingruppen)
#=======
#View(data_staatenkleingruppen)
  

data_geschlecht_heimat <- read_csv(here::here("data/raw/Geschlecht_Alter_KTZH_00002605_00005330.csv"))
#View(import_table_geschlecht)
#>>>>>>> 9d6c109c2855658793a8ce8e8da7e021c8b027b4


data_auslaenderanteil_kantonal <- read_delim('https://www.web.statistik.zh.ch/ogd/data/KANTON_ZUERICH_205.csv')
# View(import_table_auslaenderanteil_kantonal)
# tbd
# data_geo_coordinates_ktzh <- read_csv

```

# Einleitung

Die Bevölkerung in Winterthur - Ein Einblick in Altersstruktur und Migration.

## Daten

Bei den Rohdatenhandelt es sich um CSV Dateien aus dem Datenkatalog des Kantons Zürich.

[Quellen]{.underline}

-   Bevölkerung, nach Staatenkleingruppe und Quartier\
    [https://www.zh.ch/de/politik-staat/statistik-daten/datenkatalog.html#/datasets/2604\@stadt-winterthur](https://www.zh.ch/de/politik-staat/statistik-daten/datenkatalog.html#/datasets/2604@stadt-winterthur)

-   Ausländeranteil\
    <https://openzh.github.io/starter-code-openZH/>\
    [https://www.zh.ch/de/politik-staat/statistik-daten/datenkatalog.html#/datasets/68\@statistisches-amt-kanton-zuerich](https://www.zh.ch/de/politik-staat/statistik-daten/datenkatalog.html#/datasets/68@statistisches-amt-kanton-zuerich)

-   Link zum GIS Browser Datendownload\
    [https://www.zh.ch/de/politik-staat/statistik-daten/datenkatalog.html#/datasets/278\@opendata-giszh-ktzh/distributions/1](https://www.zh.ch/de/politik-staat/statistik-daten/datenkatalog.html#/datasets/278@opendata-giszh-ktzh/distributions/1) bzw. <http://maps.zh.ch/?topic=BASISKARTEZH&showtab=ogddownload>

## Analyseziele

Im Rahmen der Analyse werden die Daten aufbereitet und in ein Tidy Data Format gebracht, erkundet und visualisiert.

-   **Teil 1\
    **Erkenntnisse zur Entwicklung von **Ausländeranteil** der Stadt Winterthur (sowie der Stadkreise bzw. Quartiere) über die vergangenen 10 Jahre schaffen.

    Benötigte Daten: Jahr, Stadkreis, Quartier, Ausländeranteil

-   **Teil 2\
    **Ausländeranteil vergleichen mit **i) kantonalen Zahlen** und **ii) geografische Heatmap** erstellen.

    Benötigte Daten: Jahr, Ausländeranteil, Gebiet (inkl. Koordinaten)

# Daten Aufbereitung

Erster Teil der Analyse, Entwicklung des Ausländeranteils der vergangenen 10 Jahre.

### Staatenkleingruppen

#### Daten betrachten

```{r}

## Viewer 
gt(data_staatenkleingruppe)

## Console
kable(data_staatenkleingruppe)

glimpse(data_staatenkleingruppe)

names(data_staatenkleingruppe)
unique(data_staatenkleingruppe$staatenkleingruppe)
unique(data_staatenkleingruppe$stadtkreis)
unique(data_staatenkleingruppe$quartier)

## Einwohner pro Jahr
data_staatenkleingruppe %>%
  group_by(jahr) %>%
  summarize(summe_anzahl = sum(anzahl, na.rm = TRUE))

```

#### NA prüfen / ausschliessen

```{r}

## NA-Ausschluss für Spalte "anzahl" kann mit Filter auf "anzahl_ist_kleingruppe" gemacht werden.

## Übersicht 
data_staatenkleingruppe %>%
  group_by(anzahl_ist_kleingruppe, jahr) %>%
  summarise(anzahl_zeilen = n(),
            summe_anzahl = sum(anzahl, na.rm = TRUE))

## Auschluss NA-Zeilen
data_staatenkleingruppe_false <- data_staatenkleingruppe %>%
  filter(anzahl_ist_kleingruppe == FALSE)

```

Alternative Varianten, falls Filter auf NA-Werten nicht bereits existiert, zu dessen Überprüfung oder Wahl anderer/mehrerer Spalten:

```{r}

#| eval: false
# Code nicht ausführen

data_staatenkleingruppe_anzahl_na <- data_staatenkleingruppe %>%
  filter(is.na(anzahl)) %>%
  nrow()

    ## Alle Einträge mit MINDESTENS 1 NA in einer Spalte
    #data_staatenkleingruppe_na <- data_staatenkleingruppe %>% 
    #  filter(if_any(everything(), is.na))
    
    ## ODER
   
    #data_staatenkleingruppe_na <- data_staatenkleingruppe[!complete.cases(data_staatenkleingruppe), ]

data_staatenkleingruppe_anzahl_ohne_na <- data_staatenkleingruppe %>%
  filter(!is.na(anzahl)) %>%
  nrow()

    ## Alle Einträge OHNE NA in JEGLICHER Spalte
    #data_staatenkleingruppe_no_na <- data_staatenkleingruppe %>% 
    #filter(if_any(everything(), !is.na))
    
    ## ODER
  
    #data_staatenkleingruppe_no_na <- data_staatenkleingruppe[complete.cases(data_staatenkleingruppe), ]


cat("Zeilen ohne NA in Spalte 'anzahl':", data_staatenkleingruppe_anzahl_ohne_na, "\n")
cat("Zeilen mit NA in Spalte 'anzahl':", data_staatenkleingruppe_anzahl_na, "\n")


## Reduzierung auf Einträge ohne NA in relevanten Spalten 
data_staatenkleingruppe_false <- data_staatenkleingruppe %>%
#  filter(if_any(c(jahr, staatenkleingruppe, stadtkreis, quartier, anzahl), ~!is.na))
 filter(if_all(c(jahr, staatenkleingruppe, stadtkreis, quartier, anzahl), ~!is.na(.)))


gt(data_staatenkleingruppe_false)


```

#### Feld "**herkunft**" hinzufügen, dataframe reduzieren auf benötigte Felder und danach als CSV speichern

```{r}

data_staatenkleingruppe_reduced <- data_staatenkleingruppe_false %>% 
  mutate(herkunft = case_when(staatenkleingruppe != "Schweiz" ~  "Ausland",
                              TRUE                            ~  "Schweiz")) %>% 
  select(jahr, herkunft, stadtkreis, quartier, anzahl) %>% 
  group_by(jahr, herkunft, stadtkreis, quartier) %>% 
  summarise(anzahl = sum(anzahl), 
            .groups = "drop")

# WICHTIG: .groups Argument wird benötigt. Das Ergebnis nach Verwendung von group_by() und summarise() bleibt standardmäßig gruppiert und so ist die Anzeige viaz.B. gt() suboptimal

kable(data_staatenkleingruppe_reduced)
gt(data_staatenkleingruppe_reduced)

write_csv(x = data_staatenkleingruppe_reduced,
          here::here("data/processed/data_staatenkleingruppe_reduced.csv"))


```

#### Statistische Kennzahlen und Übersichten erstellen

Ausländeranteil der Stadt Winterthur der letzten 10 Jahre @tbl-anteile

```{r}


#| label: tbl-anteile
#| tbl-cap: "Ausländeranteil Stadt Winterthur der letzten 10 Jahre"


# Berechne die Gesamteinwohnerzahl pro Jahr


## Einwohner pro Jahr inkl. Ausländeranteil
## STADT
overview_city <- data_staatenkleingruppe_reduced %>%
  group_by(jahr) %>% 
  summarize(einwohner = sum(anzahl, na.rm = TRUE),
            einwohner_ausland = sum(anzahl[herkunft == "Ausland"], na.rm = TRUE),
            anteil_ausland = einwohner_ausland / einwohner * 100,
            einwohner_schweiz = sum(anzahl[herkunft != "Ausland"], na.rm = TRUE),
            anteil_schweiz = einwohner_schweiz / einwohner  * 100,
            ## Alternative für ungroup()
            #.groups = "drop"
            ) %>%  
  ungroup() %>%
  select(jahr,
         einwohner, einwohner_schweiz, anteil_schweiz, einwohner_ausland, anteil_ausland)

gt(overview_city)

```

Ausländeranteil der Stadtkreise von Winterthur der letzten 10 Jahre @tbl-anteile-stadtkreis

```{r}

#| label: tbl-anteile-stadtkreis
#| tbl-cap: "Ausländeranteil der Stadtkreise von Winterthur der letzten 10 Jahre"


## STADTKREIS
overview_stadtkreis <- data_staatenkleingruppe_reduced %>%
  group_by(jahr, stadtkreis) %>% 
  summarize(einw_sk = sum(anzahl, na.rm = TRUE),
            einw_sk_ausland = sum(anzahl[herkunft == "Ausland"], na.rm = TRUE),
            anteil_sk_ausland = einw_sk_ausland / einw_sk * 100,
            einw_sk_schweiz = sum(anzahl[herkunft != "Ausland"], na.rm = TRUE),
            anteil_sk_schweiz = einw_sk_schweiz / einw_sk  * 100,
            ## Alternative für ungroup()
            #.groups = "drop"
            ) %>%  
  ungroup() %>%
  left_join(overview_city, by = "jahr") %>%
  mutate(anteil_ausland_stadtkreis_gesamt = (einw_sk_ausland / einwohner) * 100) %>%
  select(jahr,
         stadtkreis,
         einw_sk,
         einw_sk_schweiz,
         anteil_sk_schweiz,
         einw_sk_ausland,
         anteil_sk_ausland,
         einwohner,
         anteil_ausland_stadtkreis_gesamt)

gt(overview_stadtkreis)


```

Ausländeranteil der Quartiere von Winterthur der letzten 10 Jahre @tbl-anteile-quartier

```{r}

#| label: tbl-anteile-quartier
#| tbl-cap: "Ausländeranteil der Quartiere von Winterthur der letzten 10 Jahre"

## Quartier
overview_quartier <- data_staatenkleingruppe_reduced %>%
  group_by(jahr, stadtkreis, quartier) %>% 
  summarize(einwohner = sum(anzahl, na.rm = TRUE),
            einwohner_ausland = sum(anzahl[herkunft == "Ausland"], na.rm = TRUE),
            anteil_ausland = einwohner_ausland / einwohner * 100,
            einwohner_schweiz = sum(anzahl[herkunft != "Ausland"], na.rm = TRUE),
            anteil_schweiz = einwohner_schweiz / einwohner  * 100,
            ## Alternative für ungroup()
            #.groups = "drop"
            ) %>%  
  ungroup() %>%
  select(jahr, stadtkreis, quartier,
         einwohner, einwohner_schweiz, anteil_schweiz, einwohner_ausland, anteil_ausland) 

gt(overview_quartier)



############################################################################
# tbd
# 
# 
# #Alter ist nicht in data_statenkleingruppe. Es wird deshalb geprüft ob diese Angabe aus einer anderen Quelle hinzugenommen werden kann.
# 
# names(data_geschlecht_heimat)
# nrow(data_geschlecht_heimat)
# glimpse(data_geschlecht_heimat)
# 
#  
# 
# Nationalität (CH/non-CH)
# 
# optional: Geschlecht 


```

# Daten Visualisierung

```{r}


#| eval: true


# Die Visualisierung auf Ebene Stadtkreis zeigt einen Ausreisser namens "unbekannt". Es handelt sich um 3 Positionen aus den Jahren 2014, 2015 und 2016 welche knapp 50 Einwohne betreffen. Es handelt sich um eine vernachlässigbare Grössenordnung und wird in dieser Betrachtung deshalb ausgeschlossen.

overview_stadtkreis_unbekannt <- overview_stadtkreis %>% 
  filter(stadtkreis == "unbekannt")

gt(overview_stadtkreis_unbekannt)

overview_stadtkreis_cleaned <- overview_stadtkreis %>% 
  filter(stadtkreis != "unbekannt")

gt(overview_stadtkreis_cleaned)

```

Stadt Winterthur und die Entwicklung des Ausländeranteils @fig-anteil-stadt

```{r}

#| label: fig-anteil-stadt
#| fig-cap: "Entwicklung des prozentualen Ausländeranteils der Stadt Winterthur"
#| warning: false


# Entwicklung Ausländeranteil
ggplot(data = overview_city, 
       mapping = aes(x = factor(jahr),
                     y = anteil_ausland)) +
  geom_col(position = "stack") +
  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1)) +
  labs(x = "Jahr",
       y = NULL,
       title = "Entwicklung Ausländeranteil",
       subtitle = "Gruppiert nach Jahr") +
  scale_y_continuous(labels = scales::percent_format(scale = 1))  

```

Stadtkreise Winterthurs und deren Entwicklung des Ausländeranteils @fig-anteil-stadtkreise (stacked)

```{r}

#| label: fig-anteil-stadtkreis
#| fig-cap: "Entwicklung des prozentualen Ausländeranteils innerhalb der Stadtkreise von Winterthur"
#| warning: false


ggplot(data = overview_stadtkreis_cleaned,
       mapping = aes(x = jahr,
                     y = einwohner,
                     fill = stadtkreis)) +
  geom_col(position = "stack") +
  geom_col(mapping = aes(x = jahr,
                         y = einwohner / 1000),
            fill = "lightblue",
            alpha = 0.5,
            position = "identity") +
  scale_y_continuous(name = "Ausländeranteil",
                     sec.axis = sec_axis(~ . * 1, name = "Gesamteinwohner")
  ) +
  labs(x = "Jahr", fill = "Stadtkreis") +
  theme_classic()
   

```

Stadtkreise Winterthurs und deren Entwicklung des Ausländeranteils @fig-anteil-stadtkreise (Ein Diagramm pro Stadtkreis)

```{r}

#| label: fig-anteil-quartier
#| fig-cap: "Entwicklung des prozentualen Ausländeranteils innerhalb der Quartiere von Winterthur"
#| warning: false

#Entwicklung Ausländeranteil nach Stadtkreis
ggplot(data = overview_stadtkreis_cleaned, 
       mapping = aes(x = factor(jahr),
                     y = anteil_sk_ausland)) +
  geom_col(position = "stack") +
  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1)) +
  labs(x = "Jahr",
       y = NULL,
       title = "Entwicklung Ausländeranteil",
       subtitle = "Gruppiert nach Jahr") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  #Ein Graph pro Stadtkreis
  facet_wrap(~ stadtkreis) +
  labs(x = "Jahr", y = "Ausländeranteil (%)", color = "Stadtkreis") 


```

WIP

```{r}


# Liniendiagramm mit Facetten
ggplot(data = overview_stadtkreis_cleaned,
       mapping = aes(x = jahr, 
                     y = einwohner_ausland, 
                     color = stadtkreis)) +
 
  
  geom_col(data = overview_stadtkreis_cleaned,
           mapping = aes(x = jahr,
                         y = einwohner),
           fill = "lightblue",
           alpha = 0.5,
           position = "identity") +
  scale_y_continuous(
    name = "Ausländeranteil (%)",
    sec.axis = sec_axis(~ . * 1, name = "Gesamteinwohner (Tausend)")
  ) +
  labs(x = "jahr") +
  theme_classic()
  


```
