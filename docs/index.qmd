---
title: "Abschlussprojekt"
subtitle: "rstatsZH-K009: "
author: "DaaniiH"
format: html
editor: visual
chunk_output_type: console
---

# Packages laden

```{r}

library(readr)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(forcats)
library(ggthemes)
library(scales)
library(lubridate)
library(knitr)     # Package wird für Funktion kable() geladen
library(DT)        # Package wird für Funktion datatable() geladen
library(gt)        # Package wird für Funktion gt() geladen

```

# Daten laden

```{r}

data_staatenkleingruppe <-  read_csv(here::here("data/raw/Quartiere_Jahr_KTZH_00002604_00005328.csv"))
#View(data_staatenkleingruppen)
  

data_geschlecht_heimat <- read_csv(here::here("data/raw/Geschlecht_Alter_KTZH_00002605_00005330.csv"))
#View(import_table_geschlecht)


data_auslaenderanteil_kantonal <- read_delim('https://www.web.statistik.zh.ch/ogd/data/KANTON_ZUERICH_205.csv')
#View(import_table_auslaenderanteil_kantonal)


#tbd
#data_geo_coordinates_ktzh <- read_csv ....
```

# Einleitung

Die Bevölkerung in Winterthur - Ein Einblick in Altersstruktur und Migration.

## Daten

Bei den Rohdatenhandelt es sich um CSV Dateien aus dem Datenkatalog des Kantons Zürich.

[Quellen]{.underline}

-   Bevölkerung, nach Staatenkleingruppe und Quartier\
    [https://www.zh.ch/de/politik-staat/statistik-daten/datenkatalog.html#/datasets/2604\@stadt-winterthur](https://www.zh.ch/de/politik-staat/statistik-daten/datenkatalog.html#/datasets/2604@stadt-winterthur)

-   Bevölkerung, nach Heimat, Geschlecht und Alter\
    [https://www.zh.ch/de/politik-staat/statistik-daten/datenkatalog.html#/datasets/2605\@stadt-winterthur](https://www.zh.ch/de/politik-staat/statistik-daten/datenkatalog.html#/datasets/2605@stadt-winterthur)

-   Bevölkerungswachstum der Stadt Winterthur ab 1985\
    [https://www.zh.ch/de/politik-staat/statistik-daten/datenkatalog.html#/datasets/1481\@stadt-winterthur](https://www.zh.ch/de/politik-staat/statistik-daten/datenkatalog.html#/datasets/1481@stadt-winterthur)

-   Ausländeranteil\
    <https://openzh.github.io/starter-code-openZH/>\
    [https://www.zh.ch/de/politik-staat/statistik-daten/datenkatalog.html#/datasets/68\@statistisches-amt-kanton-zuerich](https://www.zh.ch/de/politik-staat/statistik-daten/datenkatalog.html#/datasets/68@statistisches-amt-kanton-zuerich)

-   Link zur GIS Browser Datendownload\
    [https://www.zh.ch/de/politik-staat/statistik-daten/datenkatalog.html#/datasets/278\@opendata-giszh-ktzh/distributions/1](https://www.zh.ch/de/politik-staat/statistik-daten/datenkatalog.html#/datasets/278@opendata-giszh-ktzh/distributions/1) bzw. <http://maps.zh.ch/?topic=BASISKARTEZH&showtab=ogddownload>

## Analyseziele

Im Rahmen der Analyse werden die Daten aufbereitet und in ein Tidy Data Format gebracht, erkundet und visualisiert.

-   **Teil 1\
    **Erkenntnisse zur Entwicklung von **i)** **Ausländeranteil** und **ii)** **Altersstruktur** der Stadt Winterthur (sowie der Stadkreise bzw. Quartiere) über vergangenen 10 Jahre schaffen.

    Benötigte Daten: Jahr, Stadkreis, Quartier, Ausländeranteil, Alter

-   **Teil 2\
    **Ausländeranteil vergleichen mit **i) kantonalen Zahlen** und **ii) geografische Heatmap** erstellen.

    Benötigte Daten: Jahr, Ausländeranteil, Gebiet (inkl. Koordinaten)

# Daten Aufbereitung

Erster Teil der Analyse, Entwicklung von Altersstruktur und Ausländeranteil der vergangenen 10 Jahre.

```{r}

##############################################################################
#Daten betrachten
glimpse(data_staatenkleingruppe)
names(data_staatenkleingruppe)
unique(data_staatenkleingruppe$staatenkleingruppe)
unique(data_staatenkleingruppe$stadtkreis)
unique(data_staatenkleingruppe$quartier)

nrow(data_staatenkleingruppe)



##############################################################################
#NA in Spalte "anzahl" prüfen
data_staatenkleingruppe_anzahl_na <- data_staatenkleingruppe %>%
  filter(is.na(anzahl)) %>%
  nrow()

    ##Alle Einträge mit mind. 1 NA in einer Spalte
    #data_staatenkleingruppe_na <- data_staatenkleingruppe %>% 
    #  filter(if_any(everything(), is.na))
    
    ##ODER
   
    #data_staatenkleingruppe_na <- data_staatenkleingruppe[!complete.cases(data_staatenkleingruppe), ]

data_staatenkleingruppe_anzahl_ohne_na <- data_staatenkleingruppe %>%
  filter(!is.na(anzahl)) %>%
  nrow()

    ##Alle Einträge ohne NA in jeglicher Spalte
    #data_staatenkleingruppe_no_na <- data_staatenkleingruppe %>% 
    #filter(if_any(everything(), !is.na))
    
    ##ODER
  
    #data_staatenkleingruppe_no_na <- data_staatenkleingruppe[complete.cases(data_staatenkleingruppe), ]


cat("Zeilen ohne NA in Spalte 'anzahl':", data_staatenkleingruppe_anzahl_ohne_na, "\n")
cat("Zeilen mit NA in Spalte 'anzahl':", data_staatenkleingruppe_anzahl_na, "\n")

#Reduzierung auf Einträge ohne NA in relevanten Spalten 
data_staatenkleingruppe_no_na <- data_staatenkleingruppe %>%
#  filter(if_any(c(jahr, staatenkleingruppe, stadtkreis, quartier, anzahl), ~!is.na))
 filter(if_all(c(jahr, staatenkleingruppe, stadtkreis, quartier, anzahl), ~!is.na(.)))


gt(data_staatenkleingruppe_no_na)


##############################################################################
#Feld "herkunft" hinzufügen und dataframe reduzieren auf benötigte Felder
data_staatenkleingruppe_reduced <- data_staatenkleingruppe_no_na %>% 
  mutate(herkunft = case_when(staatenkleingruppe != "Schweiz" ~  "Ausland",
                              TRUE                            ~  "Schweiz")) %>% 
  select(jahr, herkunft, stadtkreis, quartier, anzahl) 

gt(data_staatenkleingruppe_reduced)

write_csv(x = data_staatenkleingruppe_reduced,
          here::here("data/processed/data_staatenkleingruppe_reduced.csv"))



##############################################################################
#neues dataframe inkl. Summe und prozentuale Anteile
data_staatenkleingruppe_reduced_figures <- data_staatenkleingruppe_reduced %>%
  #Gruppieren und Summe bilden
  group_by(jahr, stadtkreis, quartier, herkunft) %>%  
  # mutate(sum_city = sum(anzahl, na.rm = TRUE),
  #        pct_city = round(sum_city / anzahl * 100,1))
  summarise(sum_city = sum(anzahl, na.rm = TRUE)) %>% 
  #ungroup() %>%
  
  #Erneut gruppieren um prozentuale Anteile zu berechnen 
  group_by(jahr, stadtkreis, quartier) %>%
  mutate(sum_quartier = sum(sum_city, na.rm = TRUE),
         pct_quartier = round(sum_city / sum_quartier * 100,1)) %>%
  #ungroup() %>%
  
  #Erneut gruppieren um prozentuale Anteile zu berechnen 
  group_by(jahr, stadtkreis) %>%
  mutate(sum_stadtkreis = sum(sum, na.rm = TRUE),
         pct_stadtkreis = round(sum_city / sum_stadtkreis *100,1)) %>%
  #ungroup() %>%
  
  group_by(jahr, herkunft) %>%
  summarise(sum_city = sum(sum, na.rm = TRUE),
            pct_city = round(sum / sum_stadtkreis *100,1))

datatable(data_staatenkleingruppe_reduced_figures)





##############################################################################


# tbd
# 
# 
# #Alter ist nicht in data_statenkleingruppe. Es wird deshalb geprüft ob diese Angabe aus einer anderen Quelle hinzugenommen werden kann.
# 
# names(data_geschlecht_heimat)
# nrow(data_geschlecht_heimat)
# glimpse(data_geschlecht_heimat)
# 
# 
# 
# 
# Nationalität (CH/non-CH)
# 
# optional: Geschlecht 


```

# Daten Visualisierung

```{r}


ggplot(data = data_staatenkleingruppe_reduced_figures, 
       mapping = aes(x = factor(jahr),
                     y = pct_city,
                     fill = herkunft)) +
  geom_col(position = "stack") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Jahr",
       y = NULL,
       fill = "Herkunft",
       title = "Summe nach Herkunft über die Jahre",
       subtitle = "Gruppiert nach Jahr und Herkunft") +
  scale_y_continuous(labels = scales::percent_format(scale = 1))
  


ggplot(data = data_staatenkleingruppe_reduced_figures,
       mapping = aes(x = factor(jahr),
                     y = pct_stadtkreis,
                     fill = herkunft)) +
  geom_col(position = "stack")+
  facet_wrap(~ stadtkreis, scales = "free_y") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Jahr",
       y = NULL,
       fill = "Herkunft",
       title = "Prozentuale Verteilung nach Herkunft",
       subtitle = "pro Stadtkreis über die letzten 10 Jahre") +
  scale_y_continuous(labels = scales::percent_format(scale = 1))


```
